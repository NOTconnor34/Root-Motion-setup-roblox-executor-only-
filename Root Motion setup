local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

local Character
local Humanoid
local Animator
local HRP
local RootJoint

local StartTransform
local ActiveTrack

local function setupCharacter(char)
	Character = char
	Humanoid = Character:WaitForChild("Humanoid")
	Animator = Humanoid:WaitForChild("Animator")
	HRP = Character:WaitForChild("HumanoidRootPart")

	if Humanoid.RigType == Enum.HumanoidRigType.R15 then
		RootJoint = Character:WaitForChild("LowerTorso"):WaitForChild("Root")
	else
		RootJoint = Character:WaitForChild("Torso"):WaitForChild("RootJoint")
	end
end

local function beginRootMotion(track)
	StartTransform = RootJoint.Transform
end

local function endRootMotion()
	if not StartTransform then return end
	local delta = StartTransform:Inverse() * RootJoint.Transform
	HRP.CFrame = HRP.CFrame * delta
	RootJoint.Transform = CFrame.identity
	StartTransform = nil
	ActiveTrack = nil
end

local function hookAnimator()
	Animator.AnimationPlayed:Connect(function(track)
		if track.Name:match("Walk") or track.Name:match("Run") or track.Name:match("Jump") or track.Name:match("Fall") then
			return
		end
		track.Looped = false
		ActiveTrack = track
		beginRootMotion(track)
		track.Stopped:Once(endRootMotion)
	end)
end

if LocalPlayer.Character then
	setupCharacter(LocalPlayer.Character)
	hookAnimator()
end

LocalPlayer.CharacterAdded:Connect(function(char)
	task.wait(1)
	setupCharacter(char)
	hookAnimator()
end)
